!function(){"use strict";if(window.LiveKitAgentWidget)console.warn("LiveKitAgentWidget already initialized");else{class n{constructor(){this.config={agentName:"Agent",agentId:null,apiEndpoint:"/api/connection-details",primaryColor:"#002cf2",darkPrimaryColor:"#1fd5f9"},this.shadowRoot=null,this.container=null,this.mode=null,this.isOpen=!1,this.room=null,this.connectionDetails=null}init(n={}){this.config={...this.config,...n},this.createWidget(),this.loadLiveKitSDK()}loadLiveKitSDK(){if(window.LivekitClient)return console.log("LiveKit SDK already loaded"),void this.onLiveKitLoaded();console.log("Loading LiveKit SDK...");const n=document.createElement("script");n.src="https://unpkg.com/livekit-client@2.13.3/dist/livekit-client.umd.min.js",n.onload=()=>this.onLiveKitLoaded(),n.onerror=()=>{console.error("Failed to load LiveKit SDK"),this.showError("SDK Error","Failed to load LiveKit SDK. Please check your internet connection.")},document.head.appendChild(n)}onLiveKitLoaded(){console.log("LiveKit SDK loaded successfully")}createWidget(){this.container=document.createElement("div"),this.container.id="livekit-agent-widget-root",this.shadowRoot=this.container.attachShadow({mode:"open"}),this.injectStyles(),this.createFloatingButtons(),document.body.appendChild(this.container)}injectStyles(){const n=document.createElement("style");n.textContent=`\n        * {\n          box-sizing: border-box;\n          margin: 0;\n          padding: 0;\n        }\n\n        .lk-widget-container {\n          position: fixed;\n          z-index: 999999;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n        }\n\n        .lk-floating-buttons {\n          position: fixed;\n          bottom: 20px;\n          right: 20px;\n          display: flex;\n          flex-direction: column;\n          gap: 12px;\n          z-index: 999999;\n        }\n\n        .lk-float-btn {\n          width: 60px;\n          height: 60px;\n          border-radius: 50%;\n          border: none;\n          background: ${this.config.primaryColor};\n          color: white;\n          cursor: pointer;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 24px;\n          transition: all 0.3s ease;\n          position: relative;\n        }\n\n        .lk-float-btn:hover {\n          transform: scale(1.1);\n          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);\n        }\n\n        .lk-float-btn:active {\n          transform: scale(0.95);\n        }\n\n        .lk-float-btn::after {\n          content: attr(data-tooltip);\n          position: absolute;\n          right: 70px;\n          background: rgba(0, 0, 0, 0.8);\n          color: white;\n          padding: 6px 12px;\n          border-radius: 6px;\n          font-size: 14px;\n          white-space: nowrap;\n          opacity: 0;\n          pointer-events: none;\n          transition: opacity 0.3s ease;\n        }\n\n        .lk-float-btn:hover::after {\n          opacity: 1;\n        }\n\n        .lk-popup-overlay {\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background: rgba(0, 0, 0, 0.5);\n          z-index: 999998;\n          opacity: 0;\n          transition: opacity 0.3s ease;\n          pointer-events: none;\n        }\n\n        .lk-popup-overlay.active {\n          opacity: 1;\n          pointer-events: auto;\n        }\n\n        .lk-popup-container {\n          position: fixed;\n          bottom: 100px;\n          right: 20px;\n          width: 360px;\n          height: 480px;\n          background: white;\n          border-radius: 28px;\n          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\n          z-index: 999999;\n          transform: translateY(20px);\n          opacity: 0;\n          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n          pointer-events: none;\n          overflow: hidden;\n        }\n\n        .lk-popup-container.active {\n          transform: translateY(0);\n          opacity: 1;\n          pointer-events: auto;\n        }\n\n        .lk-iframe-container {\n          position: fixed;\n          bottom: 100px;\n          right: 20px;\n          width: 360px;\n          height: 80px;\n          background: white;\n          border-radius: 40px;\n          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);\n          z-index: 999999;\n          transform: translateY(20px);\n          opacity: 0;\n          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n          pointer-events: none;\n          overflow: hidden;\n          border: 1px solid #e5e7eb;\n        }\n\n        .lk-iframe-container.active {\n          transform: translateY(0);\n          opacity: 1;\n          pointer-events: auto;\n        }\n\n        .lk-close-btn {\n          position: absolute;\n          top: 16px;\n          right: 16px;\n          width: 32px;\n          height: 32px;\n          border-radius: 50%;\n          border: none;\n          background: rgba(0, 0, 0, 0.1);\n          color: #333;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 20px;\n          z-index: 10;\n          transition: background 0.2s ease;\n        }\n\n        .lk-close-btn:hover {\n          background: rgba(0, 0, 0, 0.2);\n        }\n\n        .lk-content {\n          width: 100%;\n          height: 100%;\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          justify-content: center;\n          padding: 20px;\n        }\n\n        .lk-welcome {\n          text-align: center;\n        }\n\n        .lk-welcome h2 {\n          font-size: 24px;\n          margin-bottom: 12px;\n          color: #1f2937;\n        }\n\n        .lk-welcome p {\n          font-size: 14px;\n          color: #6b7280;\n          margin-bottom: 24px;\n        }\n\n        .lk-start-btn {\n          background: ${this.config.primaryColor};\n          color: white;\n          border: none;\n          padding: 12px 32px;\n          border-radius: 24px;\n          font-size: 16px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.2s ease;\n        }\n\n        .lk-start-btn:hover {\n          transform: translateY(-2px);\n          box-shadow: 0 4px 12px rgba(0, 44, 242, 0.3);\n        }\n\n        .lk-start-btn:active {\n          transform: translateY(0);\n        }\n\n        .lk-session-active {\n          width: 100%;\n          height: 100%;\n          display: flex;\n          flex-direction: column;\n          background: #f9fafb;\n        }\n\n        .lk-session-header {\n          padding: 20px;\n          background: white;\n          border-bottom: 1px solid #e5e7eb;\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n        }\n\n        .lk-session-title {\n          font-size: 16px;\n          font-weight: 600;\n          color: #1f2937;\n        }\n\n        .lk-session-body {\n          flex: 1;\n          padding: 20px;\n          overflow-y: auto;\n        }\n\n        .lk-session-controls {\n          padding: 16px;\n          background: white;\n          border-top: 1px solid #e5e7eb;\n          display: flex;\n          gap: 12px;\n          justify-content: center;\n        }\n\n        .lk-control-btn {\n          width: 48px;\n          height: 48px;\n          border-radius: 50%;\n          border: none;\n          background: #f3f4f6;\n          color: #374151;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 20px;\n          transition: all 0.2s ease;\n        }\n\n        .lk-control-btn:hover {\n          background: #e5e7eb;\n        }\n\n        .lk-control-btn.active {\n          background: ${this.config.primaryColor};\n          color: white;\n        }\n\n        .lk-control-btn.danger {\n          background: #ef4444;\n          color: white;\n        }\n\n        .lk-control-btn.danger:hover {\n          background: #dc2626;\n        }\n\n        .lk-loading {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          gap: 8px;\n          color: #6b7280;\n        }\n\n        .lk-spinner {\n          width: 20px;\n          height: 20px;\n          border: 2px solid #e5e7eb;\n          border-top-color: ${this.config.primaryColor};\n          border-radius: 50%;\n          animation: spin 0.8s linear infinite;\n        }\n\n        @keyframes spin {\n          to { transform: rotate(360deg); }\n        }\n\n        .lk-error {\n          background: #fee2e2;\n          border: 1px solid #fecaca;\n          border-radius: 12px;\n          padding: 16px;\n          color: #991b1b;\n          font-size: 14px;\n          margin: 12px 0;\n        }\n\n        .lk-error-title {\n          font-weight: 600;\n          margin-bottom: 4px;\n        }\n\n        @media (max-width: 768px) {\n          .lk-popup-container,\n          .lk-iframe-container {\n            right: 10px;\n            left: 10px;\n            width: auto;\n          }\n\n          .lk-floating-buttons {\n            right: 10px;\n            bottom: 10px;\n          }\n        }\n\n        @media (prefers-color-scheme: dark) {\n          .lk-popup-container,\n          .lk-iframe-container {\n            background: #1f2937;\n            border-color: #374151;\n          }\n\n          .lk-welcome h2,\n          .lk-session-title {\n            color: #f9fafb;\n          }\n\n          .lk-welcome p {\n            color: #9ca3af;\n          }\n\n          .lk-session-active {\n            background: #111827;\n          }\n\n          .lk-session-header {\n            background: #1f2937;\n            border-color: #374151;\n          }\n\n          .lk-session-controls {\n            background: #1f2937;\n            border-color: #374151;\n          }\n\n          .lk-control-btn {\n            background: #374151;\n            color: #f9fafb;\n          }\n\n          .lk-control-btn:hover {\n            background: #4b5563;\n          }\n\n          .lk-close-btn {\n            background: rgba(255, 255, 255, 0.1);\n            color: #f9fafb;\n          }\n\n          .lk-close-btn:hover {\n            background: rgba(255, 255, 255, 0.2);\n          }\n        }\n      `,this.shadowRoot.appendChild(n)}createFloatingButtons(){const n=document.createElement("div");n.className="lk-floating-buttons";const t=document.createElement("button");t.className="lk-float-btn",t.setAttribute("data-tooltip","Open Popup Chat"),t.innerHTML="ðŸ’¬",t.onclick=()=>this.toggleMode("popup");const o=document.createElement("button");o.className="lk-float-btn",o.setAttribute("data-tooltip","Open Inline Chat"),o.innerHTML="ðŸŽ¯",o.onclick=()=>this.toggleMode("iframe"),n.appendChild(t),n.appendChild(o),this.shadowRoot.appendChild(n)}toggleMode(n){this.isOpen&&this.mode===n?this.close():this.open(n)}open(n){this.mode=n,this.isOpen=!0;const t=this.shadowRoot.querySelector(".lk-popup-container"),o=this.shadowRoot.querySelector(".lk-iframe-container"),e=this.shadowRoot.querySelector(".lk-popup-overlay");t&&t.remove(),o&&o.remove(),e&&e.remove(),"popup"===n?this.createPopupView():this.createIframeView(),this.fetchConnectionDetails()}close(){this.isOpen=!1,this.mode=null;const n=this.shadowRoot.querySelector(".lk-popup-container"),t=this.shadowRoot.querySelector(".lk-iframe-container"),o=this.shadowRoot.querySelector(".lk-popup-overlay");n&&n.classList.remove("active"),t&&t.classList.remove("active"),o&&o.classList.remove("active"),setTimeout(()=>{n&&n.remove(),t&&t.remove(),o&&o.remove()},300),this.room&&this.disconnectRoom()}createPopupView(){const n=document.createElement("div");n.className="lk-popup-overlay",n.onclick=()=>this.close();const t=document.createElement("div");t.className="lk-popup-container";const o=document.createElement("button");o.className="lk-close-btn",o.innerHTML="Ã—",o.onclick=()=>this.close();const e=document.createElement("div");e.className="lk-content",e.innerHTML=`\n        <div class="lk-welcome">\n          <h2>${this.config.agentName}</h2>\n          <p>Start a conversation with our AI agent</p>\n          <button class="lk-start-btn">Start Call</button>\n        </div>\n      `,e.querySelector(".lk-start-btn").onclick=()=>this.startSession(e),t.appendChild(o),t.appendChild(e),this.shadowRoot.appendChild(n),this.shadowRoot.appendChild(t),setTimeout(()=>{n.classList.add("active"),t.classList.add("active")},10)}createIframeView(){const n=document.createElement("div");n.className="lk-iframe-container";const t=document.createElement("div");t.className="lk-content",t.innerHTML='\n        <div class="lk-welcome">\n          <button class="lk-start-btn">Start Call</button>\n        </div>\n      ',t.querySelector(".lk-start-btn").onclick=()=>this.startSession(t);const o=document.createElement("button");o.className="lk-close-btn",o.innerHTML="Ã—",o.onclick=()=>this.close(),n.appendChild(o),n.appendChild(t),this.shadowRoot.appendChild(n),setTimeout(()=>{n.classList.add("active")},10)}async fetchConnectionDetails(){try{if(!this.config.agentId)throw new Error("agentId is required. Please provide it in the widget configuration.");let n=this.config.apiEndpoint.startsWith("http")?this.config.apiEndpoint:`${window.location.origin}${this.config.apiEndpoint}`;n+=`?agent_id=${encodeURIComponent(this.config.agentId)}`,console.log("Fetching connection details from:",n);const t=await fetch(n);if(!t.ok){const n=await t.text();throw new Error(`Server returned ${t.status}: ${n}`)}this.connectionDetails=await t.json(),console.log("Connection details received successfully")}catch(n){console.error("Error fetching connection details:",n);const t=n instanceof Error?n.message:"Unable to connect to the server";this.showError("Connection Error",t)}}async startSession(n){window.LivekitClient?(this.connectionDetails||(n.innerHTML='\n          <div class="lk-loading">\n            <div class="lk-spinner"></div>\n            <span>Connecting...</span>\n          </div>\n        ',await this.fetchConnectionDetails()),this.connectionDetails?(n.innerHTML=`\n        <div class="lk-session-active">\n          <div class="lk-session-header">\n            <div class="lk-session-title">${this.config.agentName}</div>\n          </div>\n          <div class="lk-session-body">\n            <div class="lk-loading">\n              <div class="lk-spinner"></div>\n              <span>Connecting to agent...</span>\n            </div>\n          </div>\n          <div class="lk-session-controls">\n            <button class="lk-control-btn" data-action="mic" title="Microphone">\n              ðŸŽ¤\n            </button>\n            <button class="lk-control-btn danger" data-action="end" title="End Call">\n              ðŸ“ž\n            </button>\n          </div>\n        </div>\n      `,n.querySelectorAll(".lk-control-btn").forEach(n=>{n.onclick=()=>this.handleControl(n.dataset.action,n)}),await this.connectToRoom(n)):this.showError("Connection Error","Unable to establish connection details.")):this.showError("SDK Error","LiveKit SDK not loaded. Please refresh the page.")}async connectToRoom(n){try{const{Room:t}=window.LivekitClient;this.room=new t,this.room.on("disconnected",()=>{this.close()}),this.room.on("participantConnected",t=>{console.log("Participant connected:",t.identity),this.updateSessionBody(n,"Agent connected")}),this.room.on("trackSubscribed",(n,t,o)=>{"audio"===n.kind&&n.attach()}),console.log("Connecting to room:",this.connectionDetails.serverUrl),await this.room.connect(this.connectionDetails.serverUrl,this.connectionDetails.participantToken),console.log("Connected to room successfully"),console.log("Enabling microphone..."),await this.room.localParticipant.setMicrophoneEnabled(!0),console.log("Microphone enabled"),this.updateSessionBody(n,"Connected! Speak to start the conversation.")}catch(n){console.error("Error connecting to room:",n);const t=n instanceof Error?n.message:"Unknown error occurred";this.showError("Connection Failed",t)}}updateSessionBody(n,t){const o=n.querySelector(".lk-session-body");o&&(o.innerHTML=`<p style="color: #6b7280; text-align: center;">${t}</p>`)}handleControl(n,t){if("mic"===n){if(this.room){const n=this.room.localParticipant.isMicrophoneEnabled;this.room.localParticipant.setMicrophoneEnabled(!n),t.classList.toggle("active",!n)}}else"end"===n&&this.close()}disconnectRoom(){this.room&&(this.room.disconnect(),this.room=null)}showError(n,t){this.shadowRoot.querySelectorAll(".lk-content").forEach(o=>{const e=document.createElement("div");e.className="lk-error",e.innerHTML=`\n          <div class="lk-error-title">${n}</div>\n          <div>${t}</div>\n        `,o.insertBefore(e,o.firstChild)})}}window.LiveKitAgentWidget={init:function(t){const o=new n;return o.init(t),o}}}}();